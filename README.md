# VCOM–Yuman Synchronization

## Overview

This project automates the synchronization of solar power plant data between VCOM (meteocontrol) and Yuman platforms. It ensures that technical assets, maintenance tickets, and work orders remain consistent across both systems, eliminating manual data entry and reducing operational overhead.

Persistence relies solely on Supabase's REST API—no local SQL database or SQLModel layer is required.

**Important Note**: This project was created by a non-developer, with approximately 99% of the code generated by ChatGPT o3. While the system is functional and battle-tested, it may benefit from refactoring and simplification. Users should expect potential bugs and architectural improvements in future iterations.

## What It Does

The synchronization handles three main data flows:

- **Asset Management**: Synchronizes solar installations (sites, inverters, modules, PV strings) between VCOM and Yuman
- **Ticket Management**: Transfers VCOM maintenance tickets to Yuman work orders automatically  
- **Data Integrity**: Maintains consistent mappings and resolves conflicts between systems

## How It Works

The system operates in three phases:

1. **Extraction** – Gathers systems, technical data, inverters, and tickets from VCOM using rate-limited API calls
2. **Transformation** – Maps VCOM data structures to Yuman format and stores relationships in Supabase via its REST API
3. **Loading** – Pushes processed information to Yuman and manages ticket lifecycle

All synchronization state is tracked in Supabase tables exposed through its REST interface, with conflict detection and resolution built-in.

## Quick Start

### Requirements

- **Python 3.11** 
- [Poetry](https://python-poetry.org/) (recommended) or pip

### Installation

```bash
# Using Poetry (recommended)
poetry install

# Or using pip
pip install -r requirements.txt
```

### Configuration

Copy the environment template and configure your credentials:

```bash
cp .env.example .env
```

Edit `.env` with your actual credentials:

```dotenv
VCOM_API_KEY=your-vcom-api-key
VCOM_USERNAME=your-vcom-username
VCOM_PASSWORD=your-vcom-password
YUMAN_TOKEN=your-yuman-token
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_SERVICE_KEY=your-supabase-service-key
LOG_LEVEL=INFO
```

### Basic Usage

```bash
# Full synchronization
make sync_db
make sync_tickets

# Or run specific components
poetry run python -m vysync.cli
poetry run python -m vysync.sync_tickets_workorders
```

## Available Commands

| Command | Description |
|---------|-------------|
| `make sync_db` | Synchronize sites and equipment data |
| `make sync_tickets` | Synchronize tickets and work orders |
| `make test` | Run the test suite |
| `make lint` | Check code quality |

## Architecture

### Core Components

- **VCOMAPIClient** – Production-ready VCOM API client with rate limiting
- **YumanClient** – Yuman API interface with quota management  
- **SupabaseAdapter** – Database operations and mapping storage via Supabase REST API
- **Sync Engine** – Orchestrates the three-phase synchronization process

### Data Flow

```
VCOM API → Local Snapshot → Diff Engine → Supabase (REST) → Yuman API
    ↑                                                       ↓
    ←──────────── Conflict Resolution ←─────────────────────
```

### Database Schema

The system maintains several mapping tables:
- `sites_mapping` – VCOM systems ↔ Yuman sites
- `equipments_mapping` – Technical assets across platforms
- `clients_mapping` – Customer information synchronization
- `tickets` & `work_orders` – Maintenance workflow tracking

## Automation

Daily synchronization runs automatically via GitHub Actions:

```yaml
# Runs every day at 7 AM Paris time
- cron: '0 5 * * *'
```

### GitHub Secrets Required

Configure these repository secrets for automated runs:

- `VCOM_API_KEY`
- `VCOM_USERNAME` 
- `VCOM_PASSWORD`
- `YUMAN_TOKEN`

## Development

### Testing

```bash
# Run all tests
python -m pytest -v

# Compile check
python -m py_compile $(git ls-files '*.py')
```

### Code Quality

```bash
# Lint code
poetry run ruff check src tests
```

## API Integration Examples

### VCOM Client Usage

```python
from vcom_client import VCOMAPIClient

client = VCOMAPIClient()
systems = client.get_systems()
print(f"{len(systems)} systems found")
```

### Manual Sync Operations

```python
from vysync.cli import main
from vysync.sync_tickets_workorders import main as sync_tickets

# Full sync
main()

# Tickets only  
sync_tickets()
```

## Troubleshooting

### Common Issues

- **Rate Limiting**: Both APIs have usage limits. The clients handle this automatically with exponential backoff
- **Data Conflicts**: Check the `conflicts` table in the database for resolution guidance
- **Missing Mappings**: Run the full sync process to establish all required relationships

### Logging

Set `LOG_LEVEL=DEBUG` in your `.env` file for detailed operation logs.

## Project Status & Limitations

This synchronization system is currently in production use and handles real-world data flows. However, given its AI-assisted development approach:

**Strengths:**
- Functional and battle-tested in production
- Comprehensive test coverage
- Rate-limiting and error handling built-in
- Automated conflict resolution

**Areas for Improvement:**
- Code architecture could be simplified
- Some components may be over-engineered
- Potential for refactoring with cleaner abstractions
- Documentation could be more comprehensive

**Known Limitations:**
- Requires manual resolution of certain data conflicts
- Database schema could be optimized
- Error messages could be more user-friendly

## Contributing

Given the AI-generated nature of this codebase, contributions focusing on:
- Code simplification and refactoring
- Bug fixes and edge case handling  
- Documentation improvements
- Test coverage expansion

Are particularly welcome.
