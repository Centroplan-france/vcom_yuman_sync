# VCOM–Yuman Synchronization

## Overview

This project automates the synchronization of solar power plant data between VCOM (meteocontrol) and Yuman platforms. It ensures that technical assets, maintenance tickets, and work orders remain consistent across both systems, eliminating manual data entry and reducing operational overhead.

Persistence relies solely on Supabase's REST API—no local SQL database or SQLModel layer is required.

**Important Note**: This project was created by a non-developer, with approximately 99% of the code generated by ChatGPT o3. While the system is functional and battle-tested, it may benefit from refactoring and simplification. Users should expect potential bugs and architectural improvements in future iterations.

## What It Does

The synchronization handles three main data flows:

- **Asset Management**: Synchronizes solar installations (sites, inverters, modules, PV strings) between VCOM and Yuman
- **Ticket Management**: Transfers VCOM maintenance tickets to Yuman work orders automatically
- **Data Integrity**: Maintains consistent mappings and resolves conflicts between systems

## How It Works

The system operates in three phases:

1. **Extraction** – Gathers systems, technical data, inverters, and tickets from VCOM using rate-limited API calls
2. **Transformation** – Maps VCOM data structures to Yuman format and stores relationships in Supabase via its REST API
3. **Loading** – Pushes processed information to Yuman and manages ticket lifecycle

All synchronization state is tracked in Supabase tables exposed through its REST interface, with conflict detection and resolution built-in.

## Quick Start

### Requirements

- **Python 3.11**
- [Poetry](https://python-poetry.org/) (recommended) or pip

### Installation

```bash
# Using Poetry (recommended)
poetry install

# Or using pip
pip install -r requirements.txt
```

### Configuration

Copy the environment template and configure your credentials:

```bash
cp .env.example .env
```

Edit `.env` with your actual credentials:

```dotenv
# VCOM API credentials
VCOM_API_KEY=your-vcom-api-key
VCOM_USERNAME=your-vcom-username
VCOM_PASSWORD=your-vcom-password

# Yuman API
YUMAN_TOKEN=your-yuman-token

# Supabase (used by the application)
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_SERVICE_KEY=your-supabase-service-key

# Legacy PostgreSQL connection (used by some workflows)
DATABASE_URL=postgresql://user:password@host:5432/dbname

# Logging
LOG_LEVEL=INFO
```

### Basic Usage

```bash
# Full synchronization (slow, ~25 min)
make sync_db
make sync_tickets

# Or run via Poetry directly
poetry run python -m vysync.cli --mode full
poetry run python -m vysync.sync_tickets_workorders
```

## CLI Modes

The main CLI (`vysync.cli`) supports two synchronization modes:

| Mode | Command | Duration | Use Case |
|------|---------|----------|----------|
| **quick** | `--mode quick` | ~10 seconds | Daily detection of new sites only |
| **full** | `--mode full` | ~25 minutes | Weekly complete verification of all sites |

### Examples

```bash
# Quick mode: detect new sites only (for daily cron)
poetry run python -m vysync.cli --mode quick

# Full mode: complete verification (for weekly audit)
poetry run python -m vysync.cli --mode full

# Process a specific site
poetry run python -m vysync.cli --site-key TS9A8

# Force complete update (ignore DB cache)
poetry run python -m vysync.cli --mode full --maj-all
```

## Available Commands

| Command | Description |
|---------|-------------|
| `make sync_db` | Synchronize sites and equipment data (full mode) |
| `make sync_tickets` | Synchronize tickets and work orders |
| `make test` | Run the test suite |
| `make lint` | Check code quality with ruff |
| `make dev` | Install dependencies via Poetry |

## Project Structure

```
src/vysync/
├── adapters/
│   ├── supabase_adapter.py   # Database operations via Supabase REST API
│   ├── vcom_adapter.py       # VCOM data fetching and transformation
│   └── yuman_adapter.py      # Yuman API interface with quota management
├── cli.py                    # Main CLI entry point (sync_db)
├── cli_analytics.py          # Analytics CLI
├── vcom_client.py            # VCOM API client with rate limiting
├── yuman_client.py           # Yuman API client
├── sync_tickets_workorders.py # Ticket synchronization
├── sync_new_sites.py         # New site detection
├── conflict_resolution.py    # Conflict detection and resolution
├── diff.py                   # Diff engine for entity comparison
├── models.py                 # Data models
└── ...

scripts/
├── diagnostics/              # Diagnostic and debugging scripts
└── exploration/              # Exploratory/test scripts

tests/                        # Test suite
```

## Architecture

### Core Components

- **VCOMAPIClient** (`vysync.vcom_client`) – Production-ready VCOM API client with rate limiting
- **YumanClient** (`vysync.yuman_client`) – Yuman API interface with quota management
- **SupabaseAdapter** (`vysync.adapters.supabase_adapter`) – Database operations and mapping storage via Supabase REST API
- **Sync Engine** (`vysync.cli`) – Orchestrates the three-phase synchronization process

### Data Flow

```
VCOM API → VCOMAdapter → Diff Engine → SupabaseAdapter → YumanAdapter → Yuman API
    ↑                                                                      ↓
    ←─────────────────── Conflict Resolution ←─────────────────────────────
```

### Database Schema

The system maintains several mapping tables in Supabase:
- `sites` – VCOM systems ↔ Yuman sites mapping
- `equipments` – Technical assets across platforms
- `clients_mapping` – Customer information synchronization
- `tickets` & `work_orders` – Maintenance workflow tracking

## Automation

Multiple GitHub Actions workflows run on schedules:

| Workflow | Schedule | Description |
|----------|----------|-------------|
| `sync-tickets.yml` | Daily 7h Paris | Synchronize tickets and work orders |
| `sync-new-sites.yml` | Daily | Detect new VCOM sites (quick mode) |
| `sync_yuman_supabase.yml` | Scheduled | Sync Yuman → Supabase |
| `sync_supabase_yuman.yml` | Scheduled | Sync Supabase → Yuman |
| `sync_ppc_weekly.yml` | Weekly | PPC data synchronization |
| `sync_analytics_monthly.yml` | Monthly | Analytics data sync |
| `auto_merge_sites.yml` | Scheduled | Auto-merge site conflicts |

### GitHub Secrets Required

Configure these repository secrets for automated runs:

| Secret | Description |
|--------|-------------|
| `VCOM_API_KEY` | VCOM API key |
| `VCOM_USERNAME` | VCOM username |
| `VCOM_PASSWORD` | VCOM password |
| `YUMAN_TOKEN` | Yuman API token |
| `SUPABASE_URL` | Supabase project URL |
| `SUPABASE_SERVICE_KEY` | Supabase service role key |
| `DATABASE_URL` | PostgreSQL connection string |

## Development

### Testing

```bash
# Run all tests
poetry run pytest -v

# Quick test run
make test

# Compile check
python -m py_compile $(git ls-files '*.py')
```

### Code Quality

```bash
# Lint code
make lint
# or
poetry run ruff check src tests
```

## API Integration Examples

### VCOM Client Usage

```python
from vysync.vcom_client import VCOMAPIClient

client = VCOMAPIClient()
systems = client.get_systems()
print(f"{len(systems)} systems found")
```

### Yuman Client Usage

```python
from vysync.yuman_client import YumanClient

client = YumanClient()
sites = list(client.list_sites())
print(f"{len(sites)} sites found")
```

### Running Sync Programmatically

```python
from vysync.vcom_client import VCOMAPIClient
from vysync.adapters.supabase_adapter import SupabaseAdapter
from vysync.adapters.yuman_adapter import YumanAdapter

# Initialize clients
vc = VCOMAPIClient()
sb = SupabaseAdapter()
ya = YumanAdapter(sb)

# Use adapters for sync operations
# See cli.py for full sync orchestration
```

## Troubleshooting

### Common Issues

- **Rate Limiting**: Both APIs have usage limits. The clients handle this automatically with exponential backoff
- **Missing Mappings**: Run the full sync process to establish all required relationships
- **Sync Conflicts**: The system includes automatic conflict detection and resolution in `conflict_resolution.py`

### Logging

Set `LOG_LEVEL=DEBUG` in your `.env` file for detailed operation logs.

Log files are written to the `logs/` directory:
- `logs/debug_*.log` – Complete DEBUG logs
- `logs/updates_*.log` – Equipment update details

### Diagnostic Scripts

Use scripts in `scripts/diagnostics/` to investigate issues:
- `diagnose_site_diff.py` – Compare site data between sources
- `diagnostic_site_conflicts.py` – Analyze site conflicts
- `compare_3_sources.py` – Compare VCOM, Supabase, and Yuman data

## Project Status & Limitations

This synchronization system is currently in production use and handles real-world data flows. However, given its AI-assisted development approach:

**Strengths:**
- Functional and battle-tested in production
- Comprehensive test coverage
- Rate-limiting and error handling built-in
- Automated conflict resolution

**Areas for Improvement:**
- Code architecture could be simplified
- Some components may be over-engineered
- Potential for refactoring with cleaner abstractions
- Documentation could be more comprehensive

**Known Limitations:**
- Requires manual resolution of certain data conflicts
- Database schema could be optimized
- Error messages could be more user-friendly

## Contributing

Given the AI-generated nature of this codebase, contributions focusing on:
- Code simplification and refactoring
- Bug fixes and edge case handling
- Documentation improvements
- Test coverage expansion

Are particularly welcome.
